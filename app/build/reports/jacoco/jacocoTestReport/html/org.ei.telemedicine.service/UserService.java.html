<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>UserService.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">org.ei.telemedicine.service</a> &gt; <span class="el_source">UserService.java</span></div><h1>UserService.java</h1><pre class="source lang-java linenums">package org.ei.telemedicine.service;

import org.ei.telemedicine.DristhiConfiguration;
import org.ei.telemedicine.domain.LoginResponse;
import org.ei.telemedicine.repository.AllSettings;
import org.ei.telemedicine.repository.AllSharedPreferences;
import org.ei.telemedicine.repository.Repository;
import org.ei.telemedicine.sync.SaveANMLocationTask;
import org.ei.telemedicine.util.Log;
import org.ei.telemedicine.util.Session;

import static org.ei.telemedicine.AllConstants.LOGIN_URL_PATH;
import static org.ei.telemedicine.event.Event.ON_LOGOUT;

public class UserService {
    private final Repository repository;
    private final AllSettings allSettings;
    private final AllSharedPreferences allSharedPreferences;
    private HTTPAgent httpAgent;
    private Session session;
    private DristhiConfiguration configuration;
    private SaveANMLocationTask saveANMLocationTask;

    public UserService(Repository repository, AllSettings allSettings, AllSharedPreferences allSharedPreferences, HTTPAgent httpAgent, Session session,
<span class="fc" id="L25">                       DristhiConfiguration configuration, SaveANMLocationTask saveANMLocationTask) {</span>
<span class="fc" id="L26">        this.repository = repository;</span>
<span class="fc" id="L27">        this.allSettings = allSettings;</span>
<span class="fc" id="L28">        this.allSharedPreferences = allSharedPreferences;</span>
<span class="fc" id="L29">        this.httpAgent = httpAgent;</span>
<span class="fc" id="L30">        this.session = session;</span>
<span class="fc" id="L31">        this.configuration = configuration;</span>
<span class="fc" id="L32">        this.saveANMLocationTask = saveANMLocationTask;</span>
<span class="fc" id="L33">    }</span>


    public boolean isValidLocalLogin(String userName, String password) {
<span class="fc bfc" id="L37" title="All 4 branches covered.">        return allSharedPreferences.fetchRegisteredANM().equals(userName) &amp;&amp; repository.canUseThisPassword(password);</span>
    }

    public String getUserRole() {
<span class="nc" id="L41">        return allSharedPreferences.getUserRole();</span>
    }

    public void setFormDetails(String formName, String entityId) {
<span class="nc" id="L45">        allSharedPreferences.saveFormName(formName, entityId);</span>
<span class="nc" id="L46">    }</span>

    public String getFormName() {
<span class="nc" id="L49">        return allSharedPreferences.getFormName();</span>
    }

    public String getEntityId() {
<span class="nc" id="L53">        return allSharedPreferences.getEntityKey();</span>
    }

    public LoginResponse isValidRemoteLogin(String userName, String password) {
<span class="fc" id="L57">        String requestURL = configuration.dristhiDjangoBaseURL() + LOGIN_URL_PATH + userName + &quot;&amp;pwd=&quot; + password;</span>
<span class="fc" id="L58">        android.util.Log.e(&quot;Login url&quot;, requestURL);</span>
<span class="fc" id="L59">        return httpAgent.urlCanBeAccessWithGivenCredentials(requestURL, userName, password);</span>
    }
//
//    public LoginResponse gettingVillagesWithRemoteLogin(String userName, String password) {
//        String requestURL = configuration.dristhiBaseURL() + VILLAGES_USER_URL_PATH + userName;
//        return httpAgent.urlCanBeAccessWithGivenCredentials(requestURL, userName, password);
//    }

    private void loginWith(String userName, String password) {
<span class="nc" id="L68">        setupContextForLogin(userName, password);</span>
<span class="nc" id="L69">        allSettings.registerANM(userName, password);</span>
<span class="nc" id="L70">    }</span>

    private void loginWithUserRole(String userName, String password, String userRole) {
<span class="nc" id="L73">        setupContextForLogin(userName, password);</span>
<span class="nc" id="L74">        allSettings.registerANMWithUserRole(userName, password, userRole);</span>
<span class="nc" id="L75">    }</span>

    public void localLogin(String userName, String password) {
<span class="nc" id="L78">        loginWith(userName, password);</span>
<span class="nc" id="L79">    }</span>

    public void remoteLogin(String userName, String password, String userRole, String anmLocation, String anmDrugs, String anmConfig, String anmCountryCode, String formFields) {
<span class="nc" id="L82">        loginWithUserRole(userName, password, userRole);</span>
<span class="nc" id="L83">        saveANMLocationTask.save(anmLocation, anmDrugs, anmConfig, anmCountryCode, formFields);</span>
<span class="nc" id="L84">    }</span>

    public boolean hasARegisteredUser() {
<span class="nc bnc" id="L87" title="All 2 branches missed.">        return !allSharedPreferences.fetchRegisteredANM().equals(&quot;&quot;);</span>
    }

    public void logout() {
<span class="fc" id="L91">        logoutSession();</span>
<span class="fc" id="L92">        allSettings.clearPreferences();</span>
<span class="fc" id="L93">        allSettings.registerANM(&quot;&quot;, &quot;&quot;);</span>
<span class="fc" id="L94">        allSettings.savePreviousFetchIndex(&quot;0&quot;);</span>
<span class="fc" id="L95">        repository.deleteRepository();</span>
<span class="fc" id="L96">    }</span>

    public void logoutSession() {
<span class="fc" id="L99">        session().expire();</span>
<span class="fc" id="L100">        ON_LOGOUT.notifyListeners(true);</span>
<span class="fc" id="L101">    }</span>

    public boolean hasSessionExpired() {
<span class="nc" id="L104">        return session().hasExpired();</span>
    }

    protected void setupContextForLogin(String userName, String password) {
<span class="nc" id="L108">        session().start(session().lengthInMilliseconds());</span>
<span class="nc" id="L109">        session().setPassword(password);</span>
<span class="nc" id="L110">    }</span>

    protected Session session() {
<span class="fc" id="L113">        return session;</span>
    }

    public String gettingFromRemoteURL(String requestURL) {
<span class="nc" id="L117">        return httpAgent.callingURL(requestURL);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.1.201405082137</span></div></body></html>