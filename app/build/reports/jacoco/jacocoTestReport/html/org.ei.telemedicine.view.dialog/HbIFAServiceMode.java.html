<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>HbIFAServiceMode.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">org.ei.telemedicine.view.dialog</a> &gt; <span class="el_source">HbIFAServiceMode.java</span></div><h1>HbIFAServiceMode.java</h1><pre class="source lang-java linenums">package org.ei.telemedicine.view.dialog;

import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.TextView;

import org.ei.telemedicine.AllConstants;
import org.ei.telemedicine.Context;
import org.ei.telemedicine.R;
import org.ei.telemedicine.provider.SmartRegisterClientsProvider;
import org.ei.telemedicine.util.FloatUtil;
import org.ei.telemedicine.util.IntegerUtil;
import org.ei.telemedicine.view.contract.*;
import org.ei.telemedicine.view.contract.pnc.PNCSmartRegisterClient;
import org.ei.telemedicine.view.viewHolder.*;

import static android.view.View.VISIBLE;
import static org.ei.telemedicine.AllConstants.SPACE;
import static org.ei.telemedicine.AllConstants.HbTestFields.HB_LEVEL;
import static org.ei.telemedicine.Context.getInstance;
import static org.ei.telemedicine.R.string.*;
import static org.ei.telemedicine.domain.ANCServiceType.HB_TEST;
import static org.ei.telemedicine.domain.ANCServiceType.IFA;
import static org.ei.telemedicine.view.activity.SecuredNativeSmartRegisterActivity.ClientsHeaderProvider;
import static org.ei.telemedicine.view.contract.AlertDTO.emptyAlert;
import static org.ei.telemedicine.view.contract.AlertStatus.COMPLETE;

public class HbIFAServiceMode extends ServiceModeOption {

    private LayoutInflater inflater;

    public HbIFAServiceMode(SmartRegisterClientsProvider provider) {
<span class="nc" id="L34">        super(provider);</span>
<span class="nc" id="L35">        this.inflater = LayoutInflater.from(Context.getInstance().applicationContext());</span>
<span class="nc" id="L36">    }</span>

    @Override
    public String name() {
<span class="nc" id="L40">        return getInstance().getStringResource(anc_service_mode_hb_ifa);</span>
    }

    @Override
    public ClientsHeaderProvider getHeaderProvider() {
<span class="nc" id="L45">        return new ClientsHeaderProvider() {</span>
            @Override
            public int count() {
<span class="nc" id="L48">                return 5;</span>
            }

            @Override
            public int weightSum() {
<span class="nc" id="L53">                return 100;</span>
            }

            @Override
            public int[] weights() {
<span class="nc" id="L58">                return new int[]{21, 9, 12, 26, 26};</span>
            }

            @Override
            public int[] headerTextResourceIds() {
<span class="nc" id="L63">                return new int[]{</span>
                        header_name, header_id, header_anc_status,
                        header_hb, header_ifa};
            }
        };
    }

    @Override
    public void setupListView(ChildSmartRegisterClient client, NativeChildSmartRegisterViewHolder viewHolder, View.OnClickListener clientSectionClickListener) {

<span class="nc" id="L73">    }</span>

    @Override
    public void setupListView(ANCSmartRegisterClient client,
                              NativeANCSmartRegisterViewHolder viewHolder,
                              View.OnClickListener clientSectionClickListener) {
<span class="nc" id="L79">        viewHolder.serviceModeHbIFAViewsHolder().setVisibility(VISIBLE);</span>

<span class="nc" id="L81">        setupHbDetailsLayout(client, viewHolder);</span>
<span class="nc" id="L82">        setupHbAlertLayout(client, viewHolder);</span>
<span class="nc" id="L83">        setupIFADetailsLayout(client, viewHolder);</span>
<span class="nc" id="L84">        setupIFAAlertLayout(client, viewHolder);</span>
<span class="nc" id="L85">    }</span>

    @Override
    public void setupListView(FPSmartRegisterClient client, NativeFPSmartRegisterViewHolder viewHolder, View.OnClickListener clientSectionClickListener) {

<span class="nc" id="L90">    }</span>

    @Override
    public void setupListView(PNCSmartRegisterClient client, NativePNCSmartRegisterViewHolder viewHolder, View.OnClickListener clientSectionClickListener) {

<span class="nc" id="L95">    }</span>

    public void setupHbDetailsLayout(ANCSmartRegisterClient client,
                                     NativeANCSmartRegisterViewHolder viewHolder) {
<span class="nc" id="L99">        viewHolder.layoutHbDetailsViewHolder().removeAllViews();</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">        for (ServiceProvidedDTO serviceProvided : client.allServicesProvidedForAServiceType(HB_TEST.displayName())) {</span>
<span class="nc" id="L101">            String hbLevel = serviceProvided.data().get(HB_LEVEL);</span>
<span class="nc" id="L102">            ViewGroup hbDetailsViewGroup = (ViewGroup) inflater.inflate(R.layout.smart_register_anc_hb_details_layout, null);</span>
<span class="nc" id="L103">            ((TextView) hbDetailsViewGroup.findViewById(R.id.txt_hb_date)).setText(serviceProvided.shortDate());</span>
<span class="nc" id="L104">            ((TextView) hbDetailsViewGroup.findViewById(R.id.txt_hb_level)).setText(hbLevel + getInstance().getStringResource(anc_service_mode_hb_unit));</span>
<span class="nc" id="L105">            hbDetailsViewGroup.findViewById(R.id.hb_level_indicator)</span>
                    .setBackgroundColor(getHbColor(hbLevel));

<span class="nc" id="L108">            viewHolder.layoutHbDetailsViewHolder().addView(hbDetailsViewGroup);</span>
<span class="nc" id="L109">        }</span>
<span class="nc" id="L110">    }</span>

    public void setupIFADetailsLayout(ANCSmartRegisterClient client,
                                      NativeANCSmartRegisterViewHolder viewHolder) {
<span class="nc" id="L114">        viewHolder.layoutIFADetailsViewHolder().removeAllViews();</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">        for (ServiceProvidedDTO serviceProvided : client.allServicesProvidedForAServiceType(IFA.serviceName())) {</span>
<span class="nc" id="L116">            String numberOfIFATablets = serviceProvided.data().get(&quot;dose&quot;);</span>
<span class="nc" id="L117">            ViewGroup ifaDetailsViewGroup = (ViewGroup) inflater.inflate(R.layout.smart_register_anc_ifa_details_layout, null);</span>
<span class="nc" id="L118">            ((TextView) ifaDetailsViewGroup.findViewById(R.id.txt_ifa_date)).setText(serviceProvided.shortDate());</span>
<span class="nc" id="L119">            ((TextView) ifaDetailsViewGroup.findViewById(R.id.txt_number_of_ifa_tablets))</span>
                    .setText(numberOfIFATablets + getInstance().getStringResource(anc_service_mode_ifa_tablets));
<span class="nc" id="L121">            viewHolder.layoutIFADetailsViewHolder().addView(ifaDetailsViewGroup);</span>
<span class="nc" id="L122">        }</span>
<span class="nc" id="L123">    }</span>

    public void setupIFAAlertLayout(ANCSmartRegisterClient client,
                                    NativeANCSmartRegisterViewHolder viewHolder) {
<span class="nc" id="L127">        AlertDTO ifaAlert = client.getAlert(IFA);</span>
<span class="nc" id="L128">        ServiceProvidedDTO ifaServiceProvided = client.getServiceProvidedDTO(IFA.serviceName());</span>
<span class="nc" id="L129">        viewHolder.hideViewsInIFAAlertLayout();</span>
<span class="nc bnc" id="L130" title="All 6 branches missed.">        if (ifaAlert != emptyAlert</span>
                &amp;&amp; ifaAlert.ancServiceType().name().equalsIgnoreCase(IFA.serviceName())
                &amp;&amp; !ifaAlert.status().equalsIgnoreCase(&quot;complete&quot;)) {
<span class="nc" id="L133">            viewHolder.layoutIFAAlertInHbIFAServiceMode().setVisibility(VISIBLE);</span>
<span class="nc" id="L134">            viewHolder.layoutIFAAlertInHbIFAServiceMode().setOnClickListener(launchForm(AllConstants.FormNames.IFA, client, ifaAlert));</span>
<span class="nc" id="L135">            viewHolder.txtIFAType().setVisibility(VISIBLE);</span>
<span class="nc" id="L136">            viewHolder.txtIFADate().setVisibility(VISIBLE);</span>
<span class="nc" id="L137">            setAlertLayout(viewHolder.layoutIFAAlertInHbIFAServiceMode(),</span>
                    viewHolder.txtIFAType(),
                    viewHolder.txtIFADate(), ifaAlert);
<span class="nc bnc" id="L140" title="All 2 branches missed.">        } else if (ifaServiceProvided != null) {</span>
<span class="nc" id="L141">            setServiceProvidedLayout(client,</span>
                    ifaServiceProvided, viewHolder.layoutIFAAlertInHbIFAServiceMode(),
                    viewHolder.txtIFADoneTick(), viewHolder.txtIFAType(), viewHolder.txtIFADate());
        }
<span class="nc" id="L145">    }</span>


    private int getHbColor(String hbLevel) {
<span class="nc" id="L149">        float hbValue = FloatUtil.tryParse(hbLevel, 0F);</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (hbValue &lt; 7)</span>
<span class="nc" id="L151">            return getInstance().getColorResource(R.color.hb_level_dangerous);</span>
<span class="nc bnc" id="L152" title="All 4 branches missed.">        else if (hbValue &gt;= 7 &amp;&amp; hbValue &lt; 11) {</span>
<span class="nc" id="L153">            return getInstance().getColorResource(R.color.hb_level_high);</span>
        } else {
<span class="nc" id="L155">            return getInstance().getColorResource(R.color.hb_level_normal);</span>
        }
    }

    public void setupHbAlertLayout(ANCSmartRegisterClient client,
                                   NativeANCSmartRegisterViewHolder viewHolder) {
<span class="nc" id="L161">        AlertDTO hbAlert = client.getAlert(HB_TEST);</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">        if (hbAlert != emptyAlert) {</span>
<span class="nc" id="L163">            viewHolder.btnHbView().setVisibility(View.INVISIBLE);</span>
<span class="nc" id="L164">            viewHolder.layoutHbAlert().setVisibility(VISIBLE);</span>
<span class="nc" id="L165">            viewHolder.layoutHbAlert().setOnClickListener(launchForm(AllConstants.FormNames.HB_TEST, client, hbAlert));</span>
<span class="nc" id="L166">            setAlertLayout(viewHolder.layoutHbAlert(),</span>
                    viewHolder.txtHbDueType(),
                    viewHolder.txtHbDueOn(),
                    hbAlert);
        } else {
<span class="nc" id="L171">            viewHolder.layoutHbAlert().setVisibility(View.INVISIBLE);</span>
<span class="nc" id="L172">            viewHolder.btnHbView().setVisibility(View.VISIBLE);</span>
<span class="nc" id="L173">            viewHolder.btnHbView().setOnClickListener(provider().newFormLauncher(AllConstants.FormNames.HB_TEST, client.entityId(), null));</span>
        }
<span class="nc" id="L175">    }</span>

    private OnClickFormLauncher launchForm(String formName, ANCSmartRegisterClient client, AlertDTO alert) {
<span class="nc" id="L178">        return provider().newFormLauncher(formName, client.entityId(), &quot;{\&quot;entityId\&quot;:\&quot;&quot; + client.entityId() + &quot;\&quot;,\&quot;alertName\&quot;:\&quot;&quot; + alert.name() + &quot;\&quot;}&quot;);</span>
    }

    private void setAlertLayout(View layout, TextView typeView,
                                TextView dateView, AlertDTO alert) {
<span class="nc" id="L183">        setAlertDate(dateView, alert);</span>
<span class="nc" id="L184">        typeView.setText(alert.ancServiceType().shortName());</span>

<span class="nc" id="L186">        final AlertStatus alertStatus = alert.alertStatus();</span>
<span class="nc" id="L187">        layout.setBackgroundResource(alertStatus.backgroundColorResourceId());</span>
<span class="nc" id="L188">        typeView.setTextColor(alertStatus.fontColor());</span>
<span class="nc" id="L189">        dateView.setTextColor(alertStatus.fontColor());</span>
<span class="nc" id="L190">    }</span>

    private void setAlertDate(TextView dateView, AlertDTO alert) {
<span class="nc bnc" id="L193" title="All 2 branches missed.">        if (alert.status().equalsIgnoreCase(COMPLETE.name()))</span>
<span class="nc" id="L194">            dateView.setText(alert.shortDate());</span>
        else
<span class="nc" id="L196">            dateView.setText(getInstance().getStringResource(R.string.str_due) + alert.shortDate());</span>
<span class="nc" id="L197">    }</span>

    private void setServiceProvidedLayout(ANCSmartRegisterClient client, ServiceProvidedDTO serviceProvided, View serviceProvidedLayout,
                                          TextView txtDoneTick, TextView txtServiceType, TextView txtServiceDate) {
<span class="nc" id="L201">        serviceProvidedLayout.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L202">        serviceProvidedLayout.setBackgroundResource(R.color.status_bar_text_almost_white);</span>

<span class="nc" id="L204">        txtDoneTick.setVisibility(View.VISIBLE);</span>

<span class="nc" id="L206">        txtServiceType.setVisibility(VISIBLE);</span>
<span class="nc" id="L207">        txtServiceType.setText(serviceProvided.name() + SPACE + getTotalNumberOfIFATablets(client));</span>
<span class="nc" id="L208">        txtServiceType.setTextColor(getInstance().getColorResource(R.color.text_black));</span>

<span class="nc" id="L210">        txtServiceDate.setVisibility(VISIBLE);</span>
<span class="nc" id="L211">        txtServiceDate.setText(&quot;On &quot; + serviceProvided.shortDate());</span>
<span class="nc" id="L212">        txtServiceDate.setTextColor(getInstance().getColorResource(R.color.text_black));</span>
<span class="nc" id="L213">    }</span>

    private String getTotalNumberOfIFATablets(ANCSmartRegisterClient client) {
<span class="nc" id="L216">        int totalNumberOfIFATablets = 0;</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">        for (ServiceProvidedDTO serviceProvided : client.allServicesProvidedForAServiceType(IFA.serviceName())) {</span>
<span class="nc" id="L218">            totalNumberOfIFATablets += IntegerUtil.tryParse(serviceProvided.data().get(&quot;dose&quot;), 0);</span>
<span class="nc" id="L219">        }</span>
<span class="nc" id="L220">        return Integer.toString(totalNumberOfIFATablets);</span>
    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.1.201405082137</span></div></body></html>