<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ReportRepository.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">org.ei.telemedicine.repository</a> &gt; <span class="el_source">ReportRepository.java</span></div><h1>ReportRepository.java</h1><pre class="source lang-java linenums">package org.ei.telemedicine.repository;

import android.content.ContentValues;
import android.database.Cursor;
import net.sqlcipher.database.SQLiteDatabase;

import org.ei.telemedicine.domain.Report;

import java.util.ArrayList;
import java.util.List;

import static org.apache.commons.lang3.StringUtils.repeat;

<span class="nc" id="L14">public class ReportRepository extends DrishtiRepository {</span>
    private static final String REPORT_SQL = &quot;CREATE TABLE report(indicator VARCHAR PRIMARY KEY, annualTarget VARCHAR, monthlySummaries VARCHAR)&quot;;
    private static final String REPORT_INDICATOR_INDEX_SQL = &quot;CREATE INDEX report_indicator_index ON report(indicator);&quot;;
    private static final String REPORT_TABLE_NAME = &quot;report&quot;;
    private static final String INDICATOR_COLUMN = &quot;indicator&quot;;
    private static final String ANNUAL_TARGET_COLUMN = &quot;annualTarget&quot;;
    private static final String MONTHLY_SUMMARIES_COLUMN = &quot;monthlySummaries&quot;;
<span class="nc" id="L21">    private static final String[] REPORT_TABLE_COLUMNS = {INDICATOR_COLUMN, ANNUAL_TARGET_COLUMN, MONTHLY_SUMMARIES_COLUMN};</span>

    @Override
    protected void onCreate(SQLiteDatabase database) {
<span class="nc" id="L25">        database.execSQL(REPORT_SQL);</span>
<span class="nc" id="L26">        database.execSQL(REPORT_INDICATOR_INDEX_SQL);</span>
<span class="nc" id="L27">    }</span>

    public void update(Report report) {
<span class="nc" id="L30">        SQLiteDatabase database = masterRepository.getWritableDatabase();</span>
<span class="nc" id="L31">        database.replace(REPORT_TABLE_NAME, null, createValuesFor(report));</span>
<span class="nc" id="L32">    }</span>

    public List&lt;Report&gt; allFor(String... indicators) {
<span class="nc" id="L35">        SQLiteDatabase database = masterRepository.getReadableDatabase();</span>
<span class="nc" id="L36">        Cursor cursor = database.rawQuery(String.format(&quot;SELECT * FROM %s WHERE %s IN (%s)&quot;, REPORT_TABLE_NAME, INDICATOR_COLUMN, insertPlaceholdersForInClause(indicators.length)), indicators);</span>
<span class="nc" id="L37">        return readAll(cursor);</span>
    }

    public List&lt;Report&gt; all() {
<span class="nc" id="L41">        SQLiteDatabase database = masterRepository.getReadableDatabase();</span>
<span class="nc" id="L42">        Cursor cursor = database.query(REPORT_TABLE_NAME, REPORT_TABLE_COLUMNS, null, null, null, null, null);</span>
<span class="nc" id="L43">        return readAll(cursor);</span>
    }

    private ContentValues createValuesFor(Report report) {
<span class="nc" id="L47">        ContentValues values = new ContentValues();</span>
<span class="nc" id="L48">        values.put(INDICATOR_COLUMN, report.indicator());</span>
<span class="nc" id="L49">        values.put(ANNUAL_TARGET_COLUMN, report.annualTarget());</span>
<span class="nc" id="L50">        values.put(MONTHLY_SUMMARIES_COLUMN, report.monthlySummariesJSON());</span>
<span class="nc" id="L51">        return values;</span>
    }

    private List&lt;Report&gt; readAll(Cursor cursor) {
<span class="nc" id="L55">        cursor.moveToFirst();</span>
<span class="nc" id="L56">        List&lt;Report&gt; reports = new ArrayList&lt;Report&gt;();</span>
<span class="nc bnc" id="L57" title="All 2 branches missed.">        while (!cursor.isAfterLast()) {</span>
<span class="nc" id="L58">            reports.add(read(cursor));</span>
<span class="nc" id="L59">            cursor.moveToNext();</span>
        }
<span class="nc" id="L61">        cursor.close();</span>
<span class="nc" id="L62">        return reports;</span>
    }

    private Report read(Cursor cursor) {
<span class="nc" id="L66">        return new Report(cursor.getString(0), cursor.getString(1), cursor.getString(2));</span>
    }

    private String insertPlaceholdersForInClause(int length) {
<span class="nc" id="L70">        return repeat(&quot;?&quot;, &quot;,&quot;, length);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.1.201405082137</span></div></body></html>