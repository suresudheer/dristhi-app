<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ImageLoader.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">org.ei.telemedicine.image</a> &gt; <span class="el_source">ImageLoader.java</span></div><h1>ImageLoader.java</h1><pre class="source lang-java linenums">package org.ei.telemedicine.image;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.InputStream;
import java.io.OutputStream;
import java.net.HttpURLConnection;
import java.net.URL;
import java.util.Collections;
import java.util.Map;
import java.util.WeakHashMap;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

import android.app.Activity;
import android.content.Context;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.graphics.Rect;
import android.graphics.drawable.Drawable;
import android.util.Log;
import android.widget.ImageView;

import org.ei.telemedicine.R;

public class ImageLoader {

<span class="nc" id="L30">    MemoryCache memoryCache = new MemoryCache();</span>
    FileCache fileCache;
<span class="nc" id="L32">    private Map&lt;ImageView, String&gt; imageViews = Collections.synchronizedMap(new WeakHashMap&lt;ImageView, String&gt;());</span>
    ExecutorService executorService;
    public static Drawable drawable;

<span class="nc" id="L36">    public ImageLoader(Context context) {</span>
<span class="nc" id="L37">        fileCache = new FileCache(context);</span>
<span class="nc" id="L38">        executorService = Executors.newFixedThreadPool(5);</span>
<span class="nc" id="L39">    }</span>

//    final int stub_id = R.drawable.ic_launcher;

    public void DisplayImage(String url, ImageView imageView, Drawable drawable) {
//        Log.e(&quot;disp&quot;, &quot;Image&quot;);
<span class="nc" id="L45">        this.drawable = drawable;</span>
<span class="nc bnc" id="L46" title="All 2 branches missed.">        if (url.toLowerCase().startsWith(&quot;http&quot;)) {</span>
<span class="nc" id="L47">            imageViews.put(imageView, url);</span>
<span class="nc" id="L48">            Bitmap bitmap = memoryCache.get(url);</span>
<span class="nc bnc" id="L49" title="All 2 branches missed.">            if (bitmap != null)</span>
<span class="nc" id="L50">                imageView.setImageBitmap(bitmap);</span>
            else {
<span class="nc" id="L52">                queuePhoto(url, imageView);</span>
<span class="nc" id="L53">                imageView.setImageDrawable(drawable);</span>
            }
        }
<span class="nc" id="L56">        imageView.setImageDrawable(drawable);</span>
<span class="nc" id="L57">    }</span>

    private void queuePhoto(String url, ImageView imageView) {
<span class="nc" id="L60">        PhotoToLoad p = new PhotoToLoad(url, imageView);</span>
<span class="nc" id="L61">        executorService.submit(new PhotosLoader(p));</span>
<span class="nc" id="L62">    }</span>

    public static int calculateInSampleSize(
            BitmapFactory.Options options, int reqWidth, int reqHeight) {
        // Raw height and width of image
<span class="nc" id="L67">        final int height = options.outHeight;</span>
<span class="nc" id="L68">        final int width = options.outWidth;</span>
<span class="nc" id="L69">        int inSampleSize = 1;</span>

<span class="nc bnc" id="L71" title="All 4 branches missed.">        if (height &gt; reqHeight || width &gt; reqWidth) {</span>

<span class="nc" id="L73">            final int halfHeight = height / 2;</span>
<span class="nc" id="L74">            final int halfWidth = width / 2;</span>

            // Calculate the largest inSampleSize value that is a power of 2 and keeps both
            // height and width larger than the requested height and width.
            while ((halfHeight / inSampleSize) &gt; reqHeight
<span class="nc bnc" id="L79" title="All 4 branches missed.">                    &amp;&amp; (halfWidth / inSampleSize) &gt; reqWidth) {</span>
<span class="nc" id="L80">                inSampleSize *= 2;</span>
            }
        }

<span class="nc" id="L84">        return inSampleSize;</span>
    }


    private Bitmap getBitmap(String url) {
<span class="nc" id="L89">        File f = fileCache.getFile(url);</span>
        //from SD cache
<span class="nc" id="L91">        Bitmap b = decodeFile(f);</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">        if (b != null)</span>
<span class="nc" id="L93">            return b;</span>

        //from web
        try {
<span class="nc" id="L97">            Bitmap bitmap = null;</span>
<span class="nc" id="L98">            URL imageUrl = new URL(url);</span>
<span class="nc" id="L99">            Log.e(&quot;csdf&quot;, url);</span>
<span class="nc" id="L100">            HttpURLConnection conn = (HttpURLConnection) imageUrl.openConnection();</span>
<span class="nc" id="L101">            conn.setConnectTimeout(30000);</span>
<span class="nc" id="L102">            conn.setReadTimeout(30000);</span>
<span class="nc" id="L103">            conn.setInstanceFollowRedirects(true);</span>
<span class="nc" id="L104">            InputStream is = conn.getInputStream();</span>
<span class="nc" id="L105">            OutputStream os = new FileOutputStream(f);</span>
<span class="nc" id="L106">            Utils.CopyStream(is, os);</span>
<span class="nc" id="L107">            os.close();</span>
<span class="nc" id="L108">            bitmap = decodeFile(f);</span>
<span class="nc" id="L109">            return bitmap;</span>
<span class="nc" id="L110">        } catch (Exception ex) {</span>
<span class="nc" id="L111">            ex.printStackTrace();</span>
<span class="nc" id="L112">            return null;</span>
        }
    }

    //decodes image and scales it to reduce memory consumption
    private Bitmap decodeFile(File f) {
        try {
            //decode image size
<span class="nc" id="L120">            BitmapFactory.Options o = new BitmapFactory.Options();</span>
<span class="nc" id="L121">            o.inJustDecodeBounds = true;</span>
<span class="nc" id="L122">            BitmapFactory.decodeStream(new FileInputStream(f), null, o);</span>

            //Find the correct scale value. It should be the power of 2.
<span class="nc" id="L125">            final int REQUIRED_SIZE = 70;</span>
<span class="nc" id="L126">            int width_tmp = o.outWidth, height_tmp = o.outHeight;</span>
<span class="nc" id="L127">            int scale = 1;</span>
            while (true) {
<span class="nc bnc" id="L129" title="All 4 branches missed.">                if (width_tmp / 2 &lt; REQUIRED_SIZE || height_tmp / 2 &lt; REQUIRED_SIZE)</span>
<span class="nc" id="L130">                    break;</span>
<span class="nc" id="L131">                width_tmp /= 2;</span>
<span class="nc" id="L132">                height_tmp /= 2;</span>
<span class="nc" id="L133">                scale *= 2;</span>
            }

            //decode with inSampleSize
<span class="nc" id="L137">            BitmapFactory.Options o2 = new BitmapFactory.Options();</span>
<span class="nc" id="L138">            o2.inSampleSize = scale;</span>

<span class="nc" id="L140">            Bitmap scaled = Bitmap.createScaledBitmap(BitmapFactory.decodeStream(new FileInputStream(f)), 80, 70, true);</span>
<span class="nc" id="L141">            Log.e(&quot;Scl&quot;, o2.inSampleSize + &quot;&quot; + scaled.getHeight() + &quot;===&quot; + scaled.getWidth());</span>

<span class="nc" id="L143">            return scaled;</span>
<span class="nc" id="L144">        } catch (FileNotFoundException e) {</span>
        }
<span class="nc" id="L146">        return null;</span>
    }

    //Task for the queue
    private class PhotoToLoad {
        public String url;
        public ImageView imageView;

<span class="nc" id="L154">        public PhotoToLoad(String u, ImageView i) {</span>
<span class="nc" id="L155">            url = u;</span>
<span class="nc" id="L156">            imageView = i;</span>
<span class="nc" id="L157">        }</span>
    }

    class PhotosLoader implements Runnable {
        PhotoToLoad photoToLoad;

<span class="nc" id="L163">        PhotosLoader(PhotoToLoad photoToLoad) {</span>
<span class="nc" id="L164">            this.photoToLoad = photoToLoad;</span>
<span class="nc" id="L165">        }</span>

        @Override
        public void run() {
<span class="nc bnc" id="L169" title="All 2 branches missed.">            if (imageViewReused(photoToLoad))</span>
<span class="nc" id="L170">                return;</span>
<span class="nc" id="L171">            Bitmap bmp = getBitmap(photoToLoad.url);</span>
<span class="nc" id="L172">            memoryCache.put(photoToLoad.url, bmp);</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">            if (imageViewReused(photoToLoad))</span>
<span class="nc" id="L174">                return;</span>
<span class="nc" id="L175">            BitmapDisplayer bd = new BitmapDisplayer(bmp, photoToLoad);</span>
<span class="nc" id="L176">            Activity a = (Activity) photoToLoad.imageView.getContext();</span>
<span class="nc" id="L177">            a.runOnUiThread(bd);</span>
<span class="nc" id="L178">        }</span>
    }

    boolean imageViewReused(PhotoToLoad photoToLoad) {
<span class="nc" id="L182">        String tag = imageViews.get(photoToLoad.imageView);</span>
<span class="nc bnc" id="L183" title="All 4 branches missed.">        if (tag == null || !tag.equals(photoToLoad.url))</span>
<span class="nc" id="L184">            return true;</span>
<span class="nc" id="L185">        return false;</span>
    }

    //Used to display bitmap in the UI thread
    class BitmapDisplayer implements Runnable {
        Bitmap bitmap;
        PhotoToLoad photoToLoad;

<span class="nc" id="L193">        public BitmapDisplayer(Bitmap b, PhotoToLoad p) {</span>
<span class="nc" id="L194">            bitmap = b;</span>
<span class="nc" id="L195">            photoToLoad = p;</span>
<span class="nc" id="L196">        }</span>

        public void run() {
<span class="nc bnc" id="L199" title="All 2 branches missed.">            if (imageViewReused(photoToLoad))</span>
<span class="nc" id="L200">                return;</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">            if (bitmap != null)</span>
<span class="nc" id="L202">                photoToLoad.imageView.setImageBitmap(bitmap);</span>
            else
<span class="nc" id="L204">                photoToLoad.imageView.setImageDrawable(drawable);</span>
<span class="nc" id="L205">        }</span>
    }

    public void clearCache() {
<span class="nc" id="L209">        memoryCache.clear();</span>
<span class="nc" id="L210">        fileCache.clear();</span>
<span class="nc" id="L211">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.1.201405082137</span></div></body></html>